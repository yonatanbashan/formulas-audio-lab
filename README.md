# Formula Audio Lab 
## [Live Preview](https://dmitryweiner.github.io/neural-things/formulas-audio-lab/#s=eyJ2IjoyLCJtYXN0ZXJHYWluIjowLjUxNCwiZngiOnsicGFuZWxPcGVuIjpmYWxzZSwiZmlsdGVyT24iOnRydWUsImZpbHRlclR5cGUiOiJsb3dwYXNzIiwiZmlsdGVyRnJlcSI6MzQwMCwiZmlsdGVyUSI6Ni4zLCJjaG9ydXNPbiI6dHJ1ZSwiY2hvcnVzTW9kZSI6ImNob3J1cyIsImNob3J1c1JhdGUiOjAuMDEsImNob3J1c0RlcHRoIjo4LjQsImNob3J1c01peCI6MC4zNSwiY2hvcnVzRmIiOjAuOTUsInJldmVyYk9uIjp0cnVlLCJyZXZlcmJEZWNheSI6My4yLCJyZXZlcmJNaXgiOjAuNSwibGltaXRlck9uIjp0cnVlLCJsaW1pdGVyVGhyIjotMTIsImxpbWl0ZXJSZWwiOjAuMTUsImRlbGF5T24iOnRydWUsImRlbGF5VGltZSI6MC42MywiZGVsYXlGYiI6MC42MiwiZGVsYXlNaXgiOjAuMywicGhhc2VyT24iOnRydWUsInBoYXNlclJhdGUiOjAuNDcsInBoYXNlckRlcHRoIjowLjU5LCJwaGFzZXJTdGFnZXMiOjQsInBoYXNlckZiIjowLjYyLCJwaGFzZXJNaXgiOjAuMjJ9LCJmb3JtdWxhcyI6eyJmbSI6eyJlbmFibGVkIjpmYWxzZSwiY29sbGFwc2VkIjpmYWxzZSwicGFyYW1zIjp7ImdhaW4iOjAuMTUsImZjIjoyMjAsImZtIjoyLCJJIjozfX0sImFtIjp7ImVuYWJsZWQiOmZhbHNlLCJjb2xsYXBzZWQiOmZhbHNlLCJwYXJhbXMiOnsiZ2FpbiI6MC4xNSwiZjEiOjIyMCwiZjIiOjIyMX19LCJsb2dpc3RpYyI6eyJlbmFibGVkIjpmYWxzZSwiY29sbGFwc2VkIjpmYWxzZSwicGFyYW1zIjp7ImdhaW4iOjAuMTIsImJhc2UiOjExMCwiZGVwdGgiOjMzMCwiciI6My44NiwibGZvSHoiOjQwfX0sImdsaXNzIjp7ImVuYWJsZWQiOmZhbHNlLCJjb2xsYXBzZWQiOmZhbHNlLCJwYXJhbXMiOnsiZ2FpbiI6MC4xLCJmMCI6NTUsImsiOjAuMTV9fSwiYWRkaXRpdmUiOnsiZW5hYmxlZCI6dHJ1ZSwiY29sbGFwc2VkIjpmYWxzZSwicGFyYW1zIjp7ImdhaW4iOjAuNDc0LCJmdW5kIjo1NywiTiI6MTIsIm1vdmUiOjAuMzV9fSwicG0iOnsiZW5hYmxlZCI6ZmFsc2UsImNvbGxhcHNlZCI6ZmFsc2UsInBhcmFtcyI6eyJnYWluIjowLjEyLCJmIjoyMjAsImYycG0iOjN9fSwiYmVhdHMiOnsiZW5hYmxlZCI6ZmFsc2UsImNvbGxhcHNlZCI6ZmFsc2UsInBhcmFtcyI6eyJnYWluIjowLjEyLCJmYmVhdCI6MjIwLCJkZiI6MC44fX0sImRpc3QiOnsiZW5hYmxlZCI6ZmFsc2UsImNvbGxhcHNlZCI6ZmFsc2UsInBhcmFtcyI6eyJnYWluIjowLjEsImZkIjoxMTAsImFscGhhIjozfX0sInF1YXNpIjp7ImVuYWJsZWQiOmZhbHNlLCJjb2xsYXBzZWQiOmZhbHNlLCJwYXJhbXMiOnsiZ2FpbiI6MC4xLCJmcSI6MTIwLCJBcSI6MjIwLCJ3cSI6MC44fX0sImxvcmVueiI6eyJlbmFibGVkIjpmYWxzZSwiY29sbGFwc2VkIjpmYWxzZSwicGFyYW1zIjp7ImdhaW4iOjAuMjkzLCJzaWdtYSI6MTAsInJobyI6MjgsImJldGEiOjIuNjY2NywibEJhc2UiOjEyMCwibEZyZXFTY2FsZSI6NDAsImxBbXAiOjAuMjV9fSwia2FycGx1cyI6eyJlbmFibGVkIjpmYWxzZSwiY29sbGFwc2VkIjpmYWxzZSwicGFyYW1zIjp7ImdhaW4iOjAuMTQsImtzRnJlcSI6MTEwLCJrc0RhbXAiOjAuOTg1LCJrc0JyaWdodCI6MC41fX0sImJpdGNydXNoIjp7ImVuYWJsZWQiOmZhbHNlLCJjb2xsYXBzZWQiOmZhbHNlLCJwYXJhbXMiOnsiZ2FpbiI6MC4xMiwiYmNGcmVxIjoyMjAsImJjQml0cyI6NiwiYmNEb3duIjo4fX0sIm5vaXNlbHAiOnsiZW5hYmxlZCI6ZmFsc2UsImNvbGxhcHNlZCI6ZmFsc2UsInBhcmFtcyI6eyJnYWluIjowLjEsIm5DdXQiOjgwMH19LCJwaW5rbm9pc2UiOnsiZW5hYmxlZCI6ZmFsc2UsImNvbGxhcHNlZCI6ZmFsc2UsInBhcmFtcyI6eyJnYWluIjowLjEyLCJwaW5rQnJpZ2h0IjowLjN9fSwiYnJvd25ub2lzZSI6eyJlbmFibGVkIjpmYWxzZSwiY29sbGFwc2VkIjpmYWxzZSwicGFyYW1zIjp7ImdhaW4iOjAuMTUsImJyb3duU3RlcCI6MC4wMn19LCJ2ZWx2ZXRub2lzZSI6eyJlbmFibGVkIjpmYWxzZSwiY29sbGFwc2VkIjpmYWxzZSwicGFyYW1zIjp7ImdhaW4iOjAuMSwidmVsdmV0RGVuc2l0eSI6MjAwMH19LCJyb3NzbGVyIjp7ImVuYWJsZWQiOnRydWUsImNvbGxhcHNlZCI6ZmFsc2UsInBhcmFtcyI6eyJnYWluIjowLjE2OSwicm9zc0EiOjAuMTgxLCJyb3NzQiI6MC4yMzgsInJvc3NDIjo2LjQyLCJyb3NzQmFzZSI6MzQ1LCJyb3NzRnJlcVNjYWxlIjozOC40LCJyb3NzQW1wIjowLjI1fX0sInNoZXBhcmQiOnsiZW5hYmxlZCI6ZmFsc2UsImNvbGxhcHNlZCI6ZmFsc2UsInBhcmFtcyI6eyJnYWluIjowLjEyLCJzaGVwQmFzZSI6NTUsInNoZXBTcGVlZCI6MC4xLCJzaGVwT2N0YXZlcyI6Nn19fSwic2NvcGVDb2xsYXBzZWQiOmZhbHNlfQ)

**A web application for sound synthesis based on mathematical formulas.**

An interactive audio laboratory where sound is generated in real-time via the AudioWorklet API. Each generator is a mathematical formula turned into a sound wave.

---

## Architecture

### Audio Graph

```text
[Generators] ‚Üí [MixBus] ‚Üí [FX Input] ‚Üí [Filter?] ‚Üí [Chorus?] ‚Üí [Reverb?] ‚Üí [Limiter?] ‚Üí [MasterGain] ‚Üí [Analyser] ‚Üí [Destination]
                                                                                              ‚Üì
                                                                                      [MediaStreamDest] ‚Üí Recording
```

- **AudioWorklet** (`FormulaGeneratorProcessor`) ‚Äî sample generation in a separate audio thread
- **MixBus** ‚Äî summing all active generators
- **Effects** ‚Äî optional effects chain (each can be toggled on/off)
- **Analyser** ‚Äî data for the oscilloscope

### UI State

All state is serialized to JSON:
- Saving to `localStorage` (button "Save preset")
- Encoding to URL hash via base64url (button "Share")
- Auto-loading from URL when opening the page

---

## Generators (Formulas)

Each generator can be enabled independently (checkbox), parameters are adjusted with sliders.

### 1. FM Sine (`fm`)
**Formula:** `sin(2œÄ¬∑fc¬∑t + I¬∑sin(2œÄ¬∑fm¬∑t))`

Frequency modulation. Carrier frequency `fc` is modulated by a sinusoid `fm` with modulation index `I`.

| Parameter | Description | Range |
|-----------|-------------|-------|
| `fc` | Carrier frequency (Hz) | 20‚Äì2000 |
| `fm` | Modulator frequency (Hz) | 0.1‚Äì60 |
| `I` | Modulation index | 0‚Äì20 |

---

### 2. AM / Beats (`am`)
**Formula:** `sin(2œÄ¬∑f1¬∑t) ¬∑ sin(2œÄ¬∑f2¬∑t)`

Amplitude modulation / multiplication of two sinusoids.

| Parameter | Description | Range |
|-----------|-------------|-------|
| `f1` | First frequency (Hz) | 20‚Äì2000 |
| `f2` | Second frequency (Hz) | 20‚Äì2000 |

---

### 3. Logistic Map (`logistic`)
**Formula:** `x_{n+1} = r¬∑x_n¬∑(1 - x_n)`

A chaotic system. The value `x` controls the frequency of the sinusoid.

| Parameter | Description | Range |
|-----------|-------------|-------|
| `base` | Base frequency (Hz) | 20‚Äì800 |
| `depth` | Modulation depth (Hz) | 0‚Äì1200 |
| `r` | Chaos parameter | 2.8‚Äì4.0 |
| `lfoHz` | Update rate of x | 1‚Äì400 |

**Note:** At `r < 3` ‚Äî stable, at `r ‚âà 3.57` ‚Äî period-doubling, at `r > 3.57` ‚Äî chaos.

---

### 4. Exponential Glissando (`gliss`)
**Formula:** `f(t) = f0 ¬∑ e^(k¬∑t)`

Frequency exponentially rises or falls over time.

| Parameter | Description | Range |
|-----------|-------------|-------|
| `f0` | Initial frequency (Hz) | 10‚Äì400 |
| `k` | Rate of change | -2.0‚Äì2.0 |

**Note:** Use "Reset state" to restart from the beginning.

---

### 5. Harmonic Sum (`additive`)
**Formula:** `Œ£ (1/k)¬∑sin(move¬∑t + k) ¬∑ sin(2œÄ¬∑k¬∑fund¬∑t)`

Additive synthesis with moving harmonic amplitudes.

| Parameter | Description | Range |
|-----------|-------------|-------|
| `fund` | Fundamental frequency (Hz) | 20‚Äì500 |
| `N` | Number of harmonics | 1‚Äì40 |
| `move` | Amplitude movement speed (Hz) | 0.01‚Äì5 |

---

### 6. Phase Modulation (`pm`)
**Formula:** `sin(2œÄ¬∑f¬∑t + 5¬∑sin(sin(2œÄ¬∑f2¬∑t)))`

Phase is modulated by nested sines.

| Parameter | Description | Range |
|-----------|-------------|-------|
| `f` | Carrier frequency (Hz) | 20‚Äì2000 |
| `f2pm` | Modulator frequency (Hz) | 0.1‚Äì40 |

**Note:** Use "Reset state" to reset phase.

---

### 7. Two Sines ‚Äî Beats (`beats`)
**Formula:** `0.5¬∑(sin(2œÄ¬∑f¬∑t) + sin(2œÄ¬∑(f + Œîf)¬∑t))`

Classic beats ‚Äî interference of two close frequencies.

| Parameter | Description | Range |
|-----------|-------------|-------|
| `fbeat` | Base frequency (Hz) | 20‚Äì2000 |
| `df` | Frequency difference Œîf (Hz) | 0‚Äì20 |

**Note:** Beat frequency = `Œîf` Hz.

---

### 8. Nonlinear Saturation (`dist`)
**Formula:** `tanh(Œ± ¬∑ sin(2œÄ¬∑f¬∑t))`

Soft clipping via hyperbolic tangent ‚Äî adds harmonics.

| Parameter | Description | Range |
|-----------|-------------|-------|
| `fd` | Frequency (Hz) | 20‚Äì2000 |
| `alpha` | Distortion amount | 0‚Äì10 |

---

### 9. Quasi-random LFO (`quasi`)
**Formula:** `f(t) = fq + Aq ¬∑ sin(sin(sin(w¬∑t)))`

Frequency is modulated by triple-nested sin ‚Äî produces pseudo-random behavior.

| Parameter | Description | Range |
|-----------|-------------|-------|
| `fq` | Base frequency (Hz) | 20‚Äì500 |
| `Aq` | Depth (Hz) | 0‚Äì1200 |
| `wq` | Speed w | 0.05‚Äì6 |

**Note:** Use "Reset state" to reset phase.

---

### 10. Lorenz Attractor (`lorenz`)
**Formula:** Lorenz ODE system ‚Üí freq/amp

```text
dx/dt = œÉ(y - x)
dy/dt = x(œÅ - z) - y  
dz/dt = xy - Œ≤z
```

Attractor coordinates are mapped to frequency and amplitude.

| Parameter | Description | Range |
|-----------|-------------|-------|
| `sigma` | œÉ | 0‚Äì30 |
| `rho` | œÅ | 0‚Äì60 |
| `beta` | Œ≤ | 0.1‚Äì10 |
| `lBase` | Base frequency (Hz) | 20‚Äì400 |
| `lFreqScale` | Frequency scale | 0‚Äì200 |
| `lAmp` | Amplitude scale | 0‚Äì1 |

**Classic values:** œÉ=10, œÅ=28, Œ≤=8/3 ‚âà 2.667

**Note:** Use "Reset state" to reset attractor state.

---

### 11. Karplus‚ÄìStrong (`karplus`)
**Formula:** `noise ‚Üí delay line ‚Üí averaging ‚Üí feedback`

Physical modeling of a string.

| Parameter | Description | Range |
|-----------|-------------|-------|
| `ksFreq` | Note frequency (Hz) | 40‚Äì880 |
| `ksDamp` | Damping | 0.90‚Äì0.9999 |
| `ksBright` | Brightness (filter balance) | 0‚Äì1 |

**Note:** "Reset state" ‚Äî pluck the string again.

---

### 12. Bitcrusher / Downsample (`bitcrush`)
**Formula:** `quantize(sin(phase), bits) + sample_hold(down)`

Lo-Fi effect: bit depth and sample rate reduction.

| Parameter | Description | Range |
|-----------|-------------|-------|
| `bcFreq` | Input frequency (Hz) | 20‚Äì2000 |
| `bcBits` | Bit depth | 1‚Äì16 |
| `bcDown` | Downsampling (divider) | 1‚Äì64 |

---

### 13. Noise ‚Üí Low-pass (`noiselp`)
**Formula:** `white_noise ‚Üí 1-pole LP filter`

Filtered white noise.

| Parameter | Description | Range |
|-----------|-------------|-------|
| `nCut` | Cutoff frequency (Hz) | 20‚Äì18000 |

---

### 14. Pink Noise (`pinknoise`)
**Formula:** Paul Kellet's 1/f approximation

Natural noise with 1/f spectrum ‚Äî amplitude is inversely proportional to frequency. Often used for relaxation and acoustic testing.

| Parameter | Description | Range |
|-----------|-------------|-------|
| `pinkBright` | Brightness (white noise mix) | 0‚Äì1 |

---

### 15. Brown Noise (`brownnoise`)
**Formula:** `x[n] = clamp(x[n-1] + noise * step, -1, 1)`

Brownian (red) noise ‚Äî random walk. Deep low-frequency rumble, reminiscent of ocean roar.

| Parameter | Description | Range |
|-----------|-------------|-------|
| `brownStep` | Walk step size | 0.001‚Äì0.1 |

---

### 16. Velvet Noise (`velvetnoise`)
**Formula:** sparse impulses (+1 or -1)

Sparse random impulses. Textured clicking sound, used for decorrelation and special effects.

| Parameter | Description | Range |
|-----------|-------------|-------|
| `velvetDensity` | Impulse density (imp/s) | 100‚Äì10000 |

---

### 17. Rossler Attractor (`rossler`)
**Formula:** Rossler ODE system

```text
dx/dt = -y - z
dy/dt = x + a¬∑y
dz/dt = b + z¬∑(x - c)
```

A chaotic system, similar to Lorenz, but with different motion characteristics.

| Parameter | Description | Range |
|-----------|-------------|-------|
| `rossA` | Parameter a | 0.01‚Äì0.5 |
| `rossB` | Parameter b | 0.01‚Äì0.5 |
| `rossC` | Parameter c | 2‚Äì12 |
| `rossBase` | Base frequency (Hz) | 20‚Äì400 |
| `rossFreqScale` | Frequency scale | 0‚Äì100 |
| `rossAmp` | Amplitude scale | 0‚Äì1 |

**Classic values:** a=0.2, b=0.2, c=5.7

**Note:** Use "Reset state" to reset attractor state.

---

### 18. Shepard Tone (`shepard`)
**Formula:** `Œ£ envelope(k) ¬∑ sin(2œÄ ¬∑ f0 ¬∑ 2^(k+t) ¬∑ t)`

A mesmerizing auditory illusion of endless rising (or falling). Multiple octaves of sinusoids with a Gaussian envelope over frequency.

| Parameter | Description | Range |
|-----------|-------------|-------|
| `shepBase` | Base frequency (Hz) | 20‚Äì200 |
| `shepSpeed` | Rise speed (negative = descent) | -0.5‚Äì0.5 |
| `shepOctaves` | Number of octaves | 3‚Äì10 |

**Note:** Use "Reset state" to restart the illusion.

---

## Effects

The "Effects" panel opens with a button in the top bar. Each effect is enabled with an "ON" checkbox.

### Filter (Biquad)
Standard Web Audio API biquad filter.

| Parameter | Description |
|-----------|-------------|
| Type | low-pass / high-pass / band-pass |
| Cutoff | Cutoff frequency (20‚Äì2000 Hz) |
| Q | Quality factor (0.1‚Äì30) |

### Chorus / Flanger
Modulated delay with feedback.

| Parameter | Description |
|-----------|-------------|
| Mode | chorus (base 12ms) / flanger (base 2ms) |
| Rate | LFO frequency (0.01‚Äì8 Hz) |
| Depth | Modulation depth (0‚Äì20 ms) |
| Mix | Dry/wet balance (0‚Äì1) |
| Feedback | Feedback amount (0‚Äì0.95) |

### Reverb (Convolver)
Convolution reverb with procedural impulse response.

| Parameter | Description |
|-----------|-------------|
| Decay | Decay time (0.1‚Äì8 s) |
| Mix | Dry/wet balance (0‚Äì1) |

### Limiter
Dynamic compressor in limiter mode (ratio=20).

| Parameter | Description |
|-----------|-------------|
| Threshold | Threshold (dB) (-40‚Äì0) |
| Release | Release time (0.02‚Äì1 s) |

### Delay / Echo
Classic delay with feedback for creating echoes.

| Parameter | Description |
|-----------|-------------|
| Time | Delay time (0.05‚Äì2.0 s) |
| Feedback | Feedback amount (0‚Äì0.9) |
| Mix | Dry/wet balance (0‚Äì1) |

### Phaser
Phase effect via chain of all-pass filters with LFO modulation.

| Parameter | Description |
|-----------|-------------|
| Rate | LFO frequency (0.1‚Äì10 Hz) |
| Depth | Modulation depth (0‚Äì1) |
| Stages | Number of filters (2, 4, 6, 8) |
| Feedback | Feedback amount (0‚Äì0.9) |
| Mix | Dry/wet balance (0‚Äì1) |

---

## UI Elements

### Top Bar
- **Status** ‚Äî displayed to the right of the title in gray text
- **‚ñ∂ Play / ‚èπ Stop** ‚Äî single button for starting and stopping audio (green in Play mode, red in Stop mode)
- **Record** ‚Äî record audio to WAV format (button highlights red during recording)
- **Presets dropdown** ‚Äî select a built-in preset to load instantly
- **Save preset** ‚Äî save current settings to localStorage
- **Load preset** ‚Äî restore saved settings from localStorage
- **Share** ‚Äî copies URL with state to clipboard
- **üìä** ‚Äî show/hide oscilloscope (button highlights when oscilloscope is visible)
- **üéõ** ‚Äî open/close effects panel (button highlights when panel is open)
- **?** ‚Äî open help popup with usage instructions

**Button grouping on mobile:**
Buttons are divided into logical groups with visual separators:
1. Playback controls: Play/Stop, Record
2. Preset management: Presets dropdown, Save, Load, Share
3. Panels: üìä (Scope), üéõ (Effects), ? (Help)

### Auto-start Audio
When enabling any formula (clicking checkbox) audio automatically starts if not already running. This eliminates the need to press Play first.

### Oscilloscope / Spectrogram
- **Wave/Spectrum toggle** ‚Äî button inside the scope container switches between two modes:
  - **Wave** ‚Äî classic oscilloscope (waveform on dark background with grid)
  - **Spectrum** ‚Äî spectrogram (waterfall display of frequency spectrum)
- **Spectrogram mode:**
  - **Logarithmic frequency scale** (20 Hz ‚Äî 10 kHz) ‚Äî matches human hearing perception
  - Low frequencies at bottom (more space), high at top (compressed)
  - Palette from blue (quiet) to red (loud)
  - Scrolling waterfall display
- **Wave mode:**
  - Auto-scaling on Y axis
  - Grid overlay for orientation
- Spans full screen width
- Collapses with üìä button in top bar
- When collapsed ‚Äî panel is completely hidden (takes no space)
- When hidden, drawing stops to save CPU
- Automatically hides when effects panel opens
- Collapsed by default on mobile

### Effects Panel
- Opens with üéõ button
- Has scrolling when content overflows (max-height: 60vh)
- Automatically hides oscilloscope when opened

### Help Popup
- **First visit** ‚Äî automatically shows on first app open to guide new users
- **Manual access** ‚Äî click the **?** button in top bar anytime
- **Remember preference** ‚Äî once closed, won't auto-show again (saved to localStorage)
- **Close methods** ‚Äî click ‚úï button, click outside modal, or press Escape key

### Built-in Presets
The app includes several curated presets accessible via dropdown:
- **Stillness meditation** ‚Äî calm ambient soundscape
- **Waiting for the subway** ‚Äî urban atmospheric texture
- **Inside the atomic station** ‚Äî industrial drone
- **Long journey on the helicopter** ‚Äî chaotic rhythmic atmosphere
- **Abandoned shrine** ‚Äî mysterious ambient pad

### Formula Cards
- **Disable all** ‚Äî disables all formulas at once
- **‚ñº Collapse all / ‚ñ∂ Expand all** ‚Äî collapses/expands all formulas for compact view
- Checkbox ‚Äî enable/disable generator (auto-starts audio on first enable)
- **Active formula highlighting** ‚Äî enabled generators are marked with green border on left
- **‚ñº / ‚ñ∂** ‚Äî collapse/expand formula sliders
- **+/‚àí buttons** ‚Äî next to each slider for precise one-step adjustment
- "Reset state" ‚Äî resets internal state (only for: Gliss, PM, Quasi, Lorenz, Karplus-Strong)

---

## Technical Details

### AudioWorklet Processor

```javascript
class FormulaGeneratorProcessor extends AudioWorkletProcessor {
  // Sample generation in process()
  // Communication via port.postMessage({type: 'set'|'reset', params})
}
```

### State

Only functional state is saved to URL (enabled effects/formulas and their parameters). UI state (collapsed panels) is not persisted.

```javascript
{
  v: 2,                    // format version
  masterGain: 0.25,
  fx: {
    filterOn: false, filterType: 'lowpass', filterFreq: 12000, filterQ: 0.7,
    chorusOn: false, chorusMode: 'chorus', chorusRate: 0.35, ...
    reverbOn: false, reverbDecay: 2.8, reverbMix: 0.25,
    limiterOn: false, limiterThr: -12, limiterRel: 0.15,
    delayOn: false, delayTime: 0.35, delayFb: 0.4, delayMix: 0.3,
    phaserOn: false, phaserRate: 0.5, phaserDepth: 0.7, phaserStages: 4, ...
  },
  formulas: {
    fm: { enabled: false, params: { gain: 0.15, fc: 220, ... } },
    am: { ... },
    pinknoise: { ... },
    shepard: { ... },
    ...
  }
}
```

### URL Sharing
State is encoded in base64url and added to hash:

```text
https://.../#s=eyJ2IjoyLCJtYXN0ZXJHYWluIjowLjI1LC4uLn0
```

---

## Usage Tips

1. **Always start with low Gain** ‚Äî some formulas can produce loud output
2. **Use Limiter** when experimenting with chaos (Lorenz, Rossler, Logistic)
3. **Combine generators** ‚Äî enable several simultaneously
4. **Reset state** ‚Äî available for 7 formulas: Gliss, PM, Quasi, Lorenz, Karplus-Strong, Rossler, Shepard
   - For Karplus-Strong this is "plucking" the string again
   - For Gliss ‚Äî start from f0
   - For Lorenz/Rossler ‚Äî reset attractor state
   - For Shepard ‚Äî restart illusion from beginning
5. **Disable all** ‚Äî quick way to disable all generators
6. **Noises** ‚Äî three types of noise for different purposes:
   - Pink noise ‚Äî pleasant for relaxation
   - Brown noise ‚Äî deep rumble
   - Velvet noise ‚Äî textured, clicking
7. **Shepard Tone** ‚Äî try negative speed for endless falling illusion
8. **Delay + Phaser** ‚Äî combine well with Chorus for rich sound
9. **Recording** ‚Äî use Record to save interesting sounds
   - Recording format: WAV (16-bit PCM) ‚Äî plays everywhere
   - On mobile devices: uses Web Share API for convenient file sharing
   - If automatic download doesn't work ‚Äî click the "Download" link in status

---

## iOS Specifics

Safari on iOS has an autoplay policy that requires special handling of Web Audio API:

- **AudioContext** may start in `suspended` state even after creation on user click
- In this state, the audio graph processes data (oscilloscope shows signal), but sound is not output to speakers
- The app automatically calls `resume()` on start for correct iOS operation

**For users:** Press the "‚ñ∂ Play" button or enable any formula ‚Äî sound will activate automatically.

---

## Preventing Sleep Mode (Wake Lock)

On mobile devices, the screen may automatically turn off after some inactivity. To prevent this during audio playback, the app uses **Screen Wake Lock API**.

### How It Works

- When starting audio (Play button or enabling a formula) wake lock is requested ‚Äî screen won't turn off
- When stopping audio (Stop button) wake lock is released
- If user switches to another tab or minimizes browser, browser automatically releases wake lock
- When returning to tab (if audio is still playing) wake lock is requested again

### Browser Support

| Browser | Support |
|---------|---------|
| Chrome / Edge | 84+ |
| Safari (iOS) | 16.4+ |
| Firefox | Not supported |

On unsupported browsers the feature simply doesn't activate (graceful degradation) ‚Äî app continues working, but screen may turn off per device timeout.

---

## Browser Compatibility

| Browser | Version | Status |
|---------|---------|--------|
| Chrome / Edge | 66+ | Fully supported |
| Safari (iOS/macOS) | 14.1+ | Fully supported |
| Firefox | 146+ | Fully supported |

---

## Dependencies

No external dependencies. Pure HTML + CSS + JavaScript.

- Web Audio API (AudioWorklet, BiquadFilter, Convolver, DynamicsCompressor)
- AudioWorklet for WAV recording (16-bit PCM)
- Web Share API for file sharing on mobile (optional)
- Screen Wake Lock API for preventing sleep mode (optional, not available in Firefox)
- Canvas 2D for oscilloscope

---

## Changelog

### 2025-12-31

- **Added:** **Built-in presets dropdown** ‚Äî select from 5 curated soundscapes (Stillness meditation, Waiting for the subway, etc.)
- **Added:** **Help popup** ‚Äî shows usage instructions on first visit, accessible anytime via **?** button
- **Changed:** Presets are now stored as JSON objects in `presets.js` instead of base64url hashes ‚Äî easier to read and modify

### 2025-12-25 (v2)

- **Added:** **Hold-to-repeat** for +/- buttons ‚Äî press and hold to continuously change slider values (~150ms interval)
- **Fixed:** **Background audio on Android** ‚Äî when browser is minimized, visualization stops (saves CPU) while audio continues without clicks or distortion. Upon returning, audio and visualization resume automatically

### 2025-12-25

- **Fixed:** Spectrogram now scrolls at **constant speed** regardless of browser throttling ‚Äî uses time-based updates (~30 fps) instead of per-frame updates
- **Fixed:** Effect parameter values now **update in real-time** even when audio is not playing ‚Äî labels next to sliders always reflect current values
- **Changed:** Effect slider step for Mix/Feedback increased from 0.001 to 0.01 ‚Äî buttons +/- now change values by meaningful amounts
- **Changed:** Filter Cutoff range reduced from 20‚Äì18000 Hz to **20‚Äì2000 Hz** ‚Äî more control in the musically interesting frequency range

### 2025-12-24

- **Added:** **Wave/Spectrum toggle** button inside the scope container ‚Äî switch between oscilloscope (waveform) and spectrogram display modes
- **Changed:** URL hash now only saves **functional state** (enabled effects/formulas and their parameters). UI state (collapsed panels, effects panel open/closed, scope collapsed) is no longer persisted ‚Äî cleaner, shorter URLs
- **Improved:** Spectrogram now uses **logarithmic frequency scale** (20 Hz ‚Äî 10 kHz) ‚Äî low frequencies are more visible, display matches human hearing perception
- **Fixed:** Spectrogram no longer resets when scrolling the formula list ‚Äî spectrogram data is now preserved when canvas dimensions are unchanged and copied when resizing
- **Added:** Copyright footer with link to source code on GitHub
