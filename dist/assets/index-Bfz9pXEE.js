(function(){const e=document.createElement("link").relList;if(e&&e.supports&&e.supports("modulepreload"))return;for(const a of document.querySelectorAll('link[rel="modulepreload"]'))i(a);new MutationObserver(a=>{for(const r of a)if(r.type==="childList")for(const c of r.addedNodes)c.tagName==="LINK"&&c.rel==="modulepreload"&&i(c)}).observe(document,{childList:!0,subtree:!0});function t(a){const r={};return a.integrity&&(r.integrity=a.integrity),a.referrerPolicy&&(r.referrerPolicy=a.referrerPolicy),a.crossOrigin==="use-credentials"?r.credentials="include":a.crossOrigin==="anonymous"?r.credentials="omit":r.credentials="same-origin",r}function i(a){if(a.ep)return;a.ep=!0;const r=t(a);fetch(a.href,r)}})();class Se{constructor(e){this.ctx=e,this.node=e.createBiquadFilter()}get input(){return this.node}get output(){return this.node}setType(e){this.node.type=e}setFrequency(e){this.node.frequency.setValueAtTime(e,this.ctx.currentTime)}setQ(e){this.node.Q.setValueAtTime(e,this.ctx.currentTime)}update(e,t,i){this.setType(e),this.setFrequency(t),this.setQ(i)}disconnect(){this.node.disconnect()}}class Oe{constructor(e){this.ctx=e,this.delay=e.createDelay(.2),this.dryGain=e.createGain(),this.wetGain=e.createGain(),this.feedbackGain=e.createGain(),this.lfo=e.createOscillator(),this.lfoGain=e.createGain(),this.lfo.connect(this.lfoGain),this.lfoGain.connect(this.delay.delayTime),this.lfo.start()}get dry(){return this.dryGain}get wet(){return this.wetGain}get delayNode(){return this.delay}get feedback(){return this.feedbackGain}setMode(e){const t=e==="flanger"?2:12;this.delay.delayTime.setValueAtTime(t/1e3,this.ctx.currentTime)}setRate(e){this.lfo.frequency.setValueAtTime(e,this.ctx.currentTime)}setDepth(e){this.lfoGain.gain.setValueAtTime(e/1e3,this.ctx.currentTime)}setMix(e){this.dryGain.gain.setValueAtTime(1-e,this.ctx.currentTime),this.wetGain.gain.setValueAtTime(e,this.ctx.currentTime)}setFeedback(e){this.feedbackGain.gain.setValueAtTime(e,this.ctx.currentTime)}update(e,t,i,a,r){this.setMode(e),this.setRate(t),this.setDepth(i),this.setMix(a),this.setFeedback(r)}disconnect(){this.delay.disconnect(),this.dryGain.disconnect(),this.wetGain.disconnect(),this.feedbackGain.disconnect()}stop(){try{this.lfo.stop()}catch{}}}class Le{constructor(e){this.ctx=e,this.convolver=e.createConvolver(),this.dryGain=e.createGain(),this.wetGain=e.createGain()}get convolverNode(){return this.convolver}get dry(){return this.dryGain}get wet(){return this.wetGain}makeImpulseResponse(e,t){const i=this.ctx.sampleRate,a=Math.max(1,Math.floor(i*e)),r=this.ctx.createBuffer(2,a,i);for(let c=0;c<2;c++){const u=r.getChannelData(c);for(let m=0;m<a;m++){const l=m/i,g=Math.exp(-l/Math.max(.001,t));u[m]=(Math.random()*2-1)*g}}return r}setDecay(e){const t=Math.min(6,Math.max(.3,e*1.4));this.convolver.buffer=this.makeImpulseResponse(t,e)}setMix(e){this.dryGain.gain.setValueAtTime(1-e,this.ctx.currentTime),this.wetGain.gain.setValueAtTime(e,this.ctx.currentTime)}update(e,t){this.setDecay(e),this.setMix(t)}disconnect(){this.convolver.disconnect(),this.dryGain.disconnect(),this.wetGain.disconnect()}}class Ae{constructor(e){this.ctx=e,this.compressor=e.createDynamicsCompressor(),this.compressor.ratio.value=20,this.compressor.attack.value=.003,this.compressor.knee.value=0}get input(){return this.compressor}get output(){return this.compressor}setThreshold(e){this.compressor.threshold.setValueAtTime(e,this.ctx.currentTime)}setRelease(e){this.compressor.release.setValueAtTime(e,this.ctx.currentTime)}update(e,t){this.setThreshold(e),this.setRelease(t)}disconnect(){this.compressor.disconnect()}}class De{constructor(e){this.ctx=e,this.delay=e.createDelay(3),this.dryGain=e.createGain(),this.wetGain=e.createGain(),this.feedbackGain=e.createGain()}get delayNode(){return this.delay}get dry(){return this.dryGain}get wet(){return this.wetGain}get feedback(){return this.feedbackGain}setTime(e){this.delay.delayTime.setValueAtTime(e,this.ctx.currentTime)}setFeedback(e){this.feedbackGain.gain.setValueAtTime(e,this.ctx.currentTime)}setMix(e){this.dryGain.gain.setValueAtTime(1-e,this.ctx.currentTime),this.wetGain.gain.setValueAtTime(e,this.ctx.currentTime)}update(e,t,i){this.setTime(e),this.setFeedback(t),this.setMix(i)}disconnect(){this.delay.disconnect(),this.dryGain.disconnect(),this.wetGain.disconnect(),this.feedbackGain.disconnect()}}const V=class V{constructor(e){this.ctx=e,this.filters=[],this.lfoGains=[],this.dryGain=e.createGain(),this.wetGain=e.createGain(),this.feedbackGain=e.createGain(),this.inputGain=e.createGain(),this.outputGain=e.createGain(),this.lfo=e.createOscillator(),this.lfo.type="sine",this.lfo.start();for(let t=0;t<V.MAX_STAGES;t++){const i=e.createBiquadFilter();i.type="allpass",i.frequency.value=1e3,i.Q.value=.5,this.filters.push(i);const a=e.createGain();a.gain.value=1500,this.lfo.connect(a),a.connect(i.frequency),this.lfoGains.push(a)}}get dry(){return this.dryGain}get wet(){return this.wetGain}get feedback(){return this.feedbackGain}get input(){return this.inputGain}get output(){return this.outputGain}get allFilters(){return this.filters}setRate(e){this.lfo.frequency.setValueAtTime(e,this.ctx.currentTime)}setDepth(e){const t=3e3*e;for(let i=0;i<this.filters.length;i++)this.filters[i].frequency.setValueAtTime(1e3,this.ctx.currentTime),this.lfoGains[i].gain.setValueAtTime(t,this.ctx.currentTime)}setFeedback(e){this.feedbackGain.gain.setValueAtTime(e,this.ctx.currentTime)}setMix(e){this.dryGain.gain.setValueAtTime(1-e,this.ctx.currentTime),this.wetGain.gain.setValueAtTime(e,this.ctx.currentTime)}update(e,t,i,a,r){this.setRate(e),this.setDepth(t),this.setFeedback(a),this.setMix(r)}disconnect(){this.dryGain.disconnect(),this.wetGain.disconnect(),this.feedbackGain.disconnect(),this.inputGain.disconnect(),this.outputGain.disconnect();for(const e of this.filters)e.disconnect()}stop(){try{this.lfo.stop()}catch{}}};V.MAX_STAGES=8;let ee=V;class Ee{constructor(e){this.ctx=e,this.filter=new Se(e),this.chorus=new Oe(e),this.reverb=new Le(e),this.limiter=new Ae(e),this.delay=new De(e),this.phaser=new ee(e),this.inputNode=e.createGain(),this.outputNode=e.createGain()}get input(){return this.inputNode}get output(){return this.outputNode}rebuild(e){this.disconnectAll();let t=this.inputNode;if(e.filterOn&&(t.connect(this.filter.input),t=this.filter.output),e.chorusOn){t.connect(this.chorus.dry),t.connect(this.chorus.delayNode),this.chorus.delayNode.connect(this.chorus.feedback),this.chorus.feedback.connect(this.chorus.delayNode),this.chorus.delayNode.connect(this.chorus.wet);const i=this.ctx.createGain();this.chorus.dry.connect(i),this.chorus.wet.connect(i),t=i}if(e.phaserOn){t.connect(this.phaser.dry),t.connect(this.phaser.input);let i=this.phaser.input;for(const r of this.phaser.allFilters)i.connect(r),i=r;i.connect(this.phaser.output),this.phaser.output.connect(this.phaser.feedback),this.phaser.feedback.connect(this.phaser.input),this.phaser.output.connect(this.phaser.wet);const a=this.ctx.createGain();this.phaser.dry.connect(a),this.phaser.wet.connect(a),t=a}if(e.delayOn){t.connect(this.delay.dry),t.connect(this.delay.delayNode),this.delay.delayNode.connect(this.delay.feedback),this.delay.feedback.connect(this.delay.delayNode),this.delay.delayNode.connect(this.delay.wet);const i=this.ctx.createGain();this.delay.dry.connect(i),this.delay.wet.connect(i),t=i}if(e.reverbOn){t.connect(this.reverb.dry),t.connect(this.reverb.convolverNode),this.reverb.convolverNode.connect(this.reverb.wet);const i=this.ctx.createGain();this.reverb.dry.connect(i),this.reverb.wet.connect(i),t=i}e.limiterOn&&(t.connect(this.limiter.input),t=this.limiter.output),t.connect(this.outputNode)}updateParams(e){this.filter.update(e.filterType,e.filterFreq,e.filterQ),this.chorus.update(e.chorusMode,e.chorusRate,e.chorusDepth,e.chorusMix,e.chorusFb),this.reverb.update(e.reverbDecay,e.reverbMix),this.limiter.update(e.limiterThr,e.limiterRel),this.delay.update(e.delayTime,e.delayFb,e.delayMix),this.phaser.update(e.phaserRate,e.phaserDepth,e.phaserStages,e.phaserFb,e.phaserMix)}disconnectAll(){this.inputNode.disconnect(),this.filter.disconnect(),this.chorus.disconnect(),this.reverb.disconnect(),this.limiter.disconnect(),this.delay.disconnect(),this.phaser.disconnect(),this.outputNode.disconnect()}destroy(){this.disconnectAll(),this.chorus.stop(),this.phaser.stop()}}const O=[{id:"additive",title:"Harmonic Sum",tag:"Additive",desc:"Σ aₙ(t) sin(2π n f t)",sliders:[{k:"gain",name:"Gain",min:0,max:1,step:.001,value:.12},{k:"fund",name:"Fund (Hz)",min:20,max:5e3,step:1,value:110},{k:"N",name:"Harmonics N",min:1,max:40,step:1,value:12},{k:"move",name:"Move (Hz)",min:.01,max:5,step:.01,value:.35}]},{id:"lorenz",title:"Lorenz Attractor",tag:"Lorenz",desc:"Lorenz ODE mapped to freq/amp",hasReset:!0,sliders:[{k:"gain",name:"Gain",min:0,max:1,step:.001,value:.1},{k:"sigma",name:"σ",min:0,max:30,step:.01,value:10},{k:"rho",name:"ρ",min:0,max:60,step:.01,value:28},{k:"beta",name:"β",min:.1,max:10,step:1e-4,value:2.6667},{k:"lBase",name:"Base f (Hz)",min:20,max:400,step:1,value:120},{k:"lFreqScale",name:"Freq scale",min:0,max:200,step:.1,value:40},{k:"lAmp",name:"Amp scale",min:0,max:1,step:.001,value:.25}]},{id:"rossler",title:"Rossler Attractor",tag:"Chaos",desc:"dx=-y-z, dy=x+ay, dz=b+z(x-c)",hasReset:!0,sliders:[{k:"gain",name:"Gain",min:0,max:1,step:.001,value:.1},{k:"rossA",name:"a",min:.01,max:.5,step:.001,value:.2},{k:"rossB",name:"b",min:.01,max:.5,step:.001,value:.2},{k:"rossC",name:"c",min:2,max:12,step:.01,value:5.7},{k:"rossBase",name:"Base f (Hz)",min:20,max:400,step:1,value:120},{k:"rossFreqScale",name:"Freq scale",min:0,max:100,step:.1,value:30},{k:"rossAmp",name:"Amp scale",min:0,max:1,step:.001,value:.25}]},{id:"gliss",title:"Exponential Glissando",tag:"Gliss",desc:"f(t)=f0·e^{k t}",hasReset:!0,sliders:[{k:"gain",name:"Gain",min:0,max:1,step:.001,value:.1},{k:"f0",name:"f0 (Hz)",min:10,max:400,step:1,value:55},{k:"k",name:"k",min:-2,max:2,step:.001,value:.15}]},{id:"shepard",title:"Shepard Tone",tag:"Illusion",desc:"Endless rising illusion",hasReset:!0,sliders:[{k:"gain",name:"Gain",min:0,max:1,step:.001,value:.12},{k:"shepBase",name:"Base f (Hz)",min:20,max:200,step:1,value:55},{k:"shepSpeed",name:"Speed",min:-.5,max:.5,step:.001,value:.1},{k:"shepOctaves",name:"Octaves",min:3,max:10,step:1,value:6}]},{id:"fm",title:"FM Sine",tag:"FM",desc:"sin(2π f_c t + I sin(2π f_m t))",sliders:[{k:"gain",name:"Gain",min:0,max:1,step:.001,value:.15},{k:"fc",name:"f_c (Hz)",min:20,max:2e3,step:1,value:220},{k:"fm",name:"f_m (Hz)",min:.1,max:60,step:.1,value:2},{k:"I",name:"Index I",min:0,max:20,step:.01,value:3}]},{id:"beats",title:"Two Sines (Beats)",tag:"Beats",desc:"sin(2π f t)+sin(2π(f+Δf)t)",sliders:[{k:"gain",name:"Gain",min:0,max:1,step:.001,value:.12},{k:"fbeat",name:"f (Hz)",min:20,max:2e3,step:1,value:220},{k:"df",name:"Δf (Hz)",min:0,max:20,step:.01,value:.8}]},{id:"pm",title:"Phase Modulation",tag:"PM",desc:"sin(2π f t + 5·sin(sin(2π f2 t)))",hasReset:!0,sliders:[{k:"gain",name:"Gain",min:0,max:1,step:.001,value:.12},{k:"f",name:"f (Hz)",min:20,max:2e3,step:1,value:220},{k:"f2pm",name:"f2 (Hz)",min:.1,max:40,step:.1,value:3}]},{id:"quasi",title:"Quasi-random LFO",tag:"Quasi",desc:"f(t)=fq + Aq·sin(sin(sin(w·t)))",hasReset:!0,sliders:[{k:"gain",name:"Gain",min:0,max:1,step:.001,value:.1},{k:"fq",name:"Base f (Hz)",min:20,max:500,step:1,value:120},{k:"Aq",name:"Depth (Hz)",min:0,max:1200,step:1,value:220},{k:"wq",name:"w",min:.05,max:6,step:.01,value:.8}]},{id:"logistic",title:"Logistic Map",tag:"Chaos",desc:"xₙ₊₁ = r xₙ(1−xₙ)",sliders:[{k:"gain",name:"Gain",min:0,max:1,step:.001,value:.12},{k:"base",name:"Base f (Hz)",min:20,max:800,step:1,value:110},{k:"depth",name:"Depth (Hz)",min:0,max:1200,step:1,value:330},{k:"r",name:"r",min:2.8,max:4,step:1e-4,value:3.86},{k:"lfoHz",name:"Update rate (Hz)",min:1,max:400,step:1,value:40}]},{id:"dist",title:"Nonlinear Saturation",tag:"tanh",desc:"tanh(α·sin(2π f t))",sliders:[{k:"gain",name:"Gain",min:0,max:1,step:.001,value:.1},{k:"fd",name:"f (Hz)",min:20,max:2e3,step:1,value:110},{k:"alpha",name:"α",min:0,max:10,step:.01,value:3}]},{id:"karplus",title:"Karplus–Strong (String)",tag:"KS",desc:"noise-in-delay + averaging + damping",hasReset:!0,sliders:[{k:"gain",name:"Gain",min:0,max:1,step:.001,value:.14},{k:"ksFreq",name:"Freq (Hz)",min:40,max:880,step:1,value:110},{k:"ksDamp",name:"Damping",min:.9,max:.9999,step:1e-4,value:.985},{k:"ksBright",name:"Brightness",min:0,max:1,step:.001,value:.5}]},{id:"noiselp",title:"Noise → Low-pass",tag:"Noise",desc:"white noise → 1-pole LP",sliders:[{k:"gain",name:"Gain",min:0,max:1,step:.001,value:.1},{k:"nCut",name:"Cutoff (Hz)",min:20,max:18e3,step:1,value:800}]},{id:"pinknoise",title:"Pink Noise (1/f)",tag:"Noise",desc:"Natural 1/f spectrum noise",sliders:[{k:"gain",name:"Gain",min:0,max:1,step:.001,value:.12},{k:"pinkBright",name:"Brightness",min:0,max:1,step:.01,value:.3}]},{id:"brownnoise",title:"Brown Noise (Brownian)",tag:"Noise",desc:"Random walk — deep rumble",sliders:[{k:"gain",name:"Gain",min:0,max:1,step:.001,value:.15},{k:"brownStep",name:"Step size",min:.001,max:.1,step:.001,value:.02}]},{id:"velvetnoise",title:"Velvet Noise",tag:"Noise",desc:"Sparse random impulses",sliders:[{k:"gain",name:"Gain",min:0,max:1,step:.001,value:.1},{k:"velvetDensity",name:"Density (imp/s)",min:100,max:1e4,step:10,value:2e3}]}];let D=null;async function fe(){if("wakeLock"in navigator)try{D=await navigator.wakeLock.request("screen"),D.addEventListener("release",()=>{D=null})}catch(s){const e=s;console.log("Wake Lock error:",e.name,e.message)}}async function Be(){D&&(await D.release(),D=null)}const te=new Set;function ve(){return document.visibilityState==="visible"}function qe(s){return te.add(s),()=>te.delete(s)}document.addEventListener("visibilitychange",()=>{const s=ve();te.forEach(e=>e(s))});function z(s,e,t){for(let i=0;i<t.length;i++)s.setUint8(e+i,t.charCodeAt(i))}function Ne(s,e){const c=e*2,u=s.length*2,m=new ArrayBuffer(44+u),l=new DataView(m);z(l,0,"RIFF"),l.setUint32(4,36+u,!0),z(l,8,"WAVE"),z(l,12,"fmt "),l.setUint32(16,16,!0),l.setUint16(20,1,!0),l.setUint16(22,1,!0),l.setUint32(24,e,!0),l.setUint32(28,c,!0),l.setUint16(32,2,!0),l.setUint16(34,16,!0),z(l,36,"data"),l.setUint32(40,u,!0);let g=44;for(let f=0;f<s.length;f++){let y=Math.max(-1,Math.min(1,s[f]));y=y<0?y*32768:y*32767,l.setInt16(g,y,!0),g+=2}return new Blob([m],{type:"audio/wav"})}function Pe(){return`formula-audio-${new Date().toISOString().replace(/[:.]/g,"-")}.wav`}class _e extends EventTarget{constructor(){super(...arguments),this.ctx=null,this.analyser=null,this.mixBus=null,this.masterGain=null,this.effectsChain=null,this.generators=new Map,this.recorderNode=null,this._isRecording=!1,this.visibilityUnsubscribe=null}get isRunning(){return this.ctx!==null&&this.ctx.state==="running"}get isRecording(){return this._isRecording}get audioContext(){return this.ctx}get analyserNode(){return this.analyser}get sampleRate(){var e;return((e=this.ctx)==null?void 0:e.sampleRate)??44100}async start(e){var r,c;if(this.ctx)return;this.ctx=new AudioContext({latencyHint:"interactive"}),this.ctx.state==="suspended"&&await this.ctx.resume();const t=new URL(""+new URL("formula-generator.worklet-ctKEhjEJ.ts",import.meta.url).href,import.meta.url),i=new URL(""+new URL("recorder.worklet-CqP8d2r5.ts",import.meta.url).href,import.meta.url);await Promise.all([this.ctx.audioWorklet.addModule(t),this.ctx.audioWorklet.addModule(i)]),this.analyser=this.ctx.createAnalyser(),this.analyser.fftSize=2048,this.mixBus=this.ctx.createGain(),this.mixBus.gain.value=1,this.masterGain=this.ctx.createGain(),this.masterGain.gain.value=(e==null?void 0:e.masterGain)??.25,this.effectsChain=new Ee(this.ctx),this.mixBus.connect(this.effectsChain.input),this.effectsChain.output.connect(this.masterGain),this.masterGain.connect(this.analyser),this.analyser.connect(this.ctx.destination),this.recorderNode=new AudioWorkletNode(this.ctx,"recorder-processor",{numberOfInputs:1,numberOfOutputs:1,outputChannelCount:[1]}),this.masterGain.connect(this.recorderNode);const a=this.ctx.createGain();a.gain.value=0,this.recorderNode.connect(a),a.connect(this.ctx.destination);for(const u of O){const m={};for(const f of u.sliders){const y=(c=(r=e==null?void 0:e.formulas)==null?void 0:r[u.id])==null?void 0:c.params;m[f.k]=(y==null?void 0:y[f.k])??f.value}const l=new AudioWorkletNode(this.ctx,"formula-generator",{numberOfInputs:0,numberOfOutputs:1,outputChannelCount:[1],processorOptions:{formula:u.id,params:m}}),g=this.ctx.createGain();g.gain.value=0,l.connect(g),g.connect(this.mixBus),this.generators.set(u.id,{worklet:l,gain:g,params:m})}if(e!=null&&e.fx&&this.updateEffects(e.fx),e!=null&&e.formulas)for(const[u,m]of Object.entries(e.formulas))m.enabled&&this.enableFormula(u,!0);await fe(),this.visibilityUnsubscribe=qe(async u=>{u&&this.ctx&&(this.ctx.state==="suspended"&&await this.ctx.resume(),await fe())}),this.dispatchEvent(new Event("start"))}async stop(){var t,i;if(!this.ctx)return;this._isRecording&&await this.stopRecording(),await Be(),this.visibilityUnsubscribe&&(this.visibilityUnsubscribe(),this.visibilityUnsubscribe=null);const e=this.ctx.currentTime;(t=this.masterGain)==null||t.gain.setTargetAtTime(0,e,.01),await new Promise(a=>setTimeout(a,80)),(i=this.effectsChain)==null||i.destroy(),await this.ctx.close(),this.ctx=null,this.analyser=null,this.mixBus=null,this.masterGain=null,this.effectsChain=null,this.recorderNode=null,this.generators.clear(),this.dispatchEvent(new Event("stop"))}setMasterGain(e){this.masterGain&&(this.masterGain.gain.value=e)}enableFormula(e,t){const i=this.generators.get(e);if(!i||!this.ctx)return;const a=this.ctx.currentTime,r=t?i.params.gain??.2:0;i.gain.gain.setTargetAtTime(r,a,.02)}updateFormulaParam(e,t,i){const a=this.generators.get(e);if(!a)return;a.params[t]=i;const r={type:"set",params:{[t]:i}};a.worklet.port.postMessage(r),t==="gain"&&a.gain.gain.value>0&&this.ctx&&a.gain.gain.setTargetAtTime(i,this.ctx.currentTime,.02)}resetFormula(e){const t=this.generators.get(e);if(!t)return;const i={type:"reset"};t.worklet.port.postMessage(i)}updateEffects(e){!this.effectsChain||!this.mixBus||!this.masterGain||(this.mixBus.disconnect(),this.effectsChain.output.disconnect(),this.effectsChain.rebuild(e),this.effectsChain.updateParams(e),this.mixBus.connect(this.effectsChain.input),this.effectsChain.output.connect(this.masterGain))}updateEffectParams(e){var t;(t=this.effectsChain)==null||t.updateParams(e)}startRecording(){!this.recorderNode||this._isRecording||(this._isRecording=!0,this.recorderNode.port.postMessage({type:"start"}),this.dispatchEvent(new Event("recording-start")))}async stopRecording(){return!this.recorderNode||!this._isRecording||!this.ctx?null:new Promise(e=>{this.recorderNode.port.onmessage=t=>{if(t.data.type==="data"){this._isRecording=!1;const i=Ne(t.data.samples,this.ctx.sampleRate),a=Pe();this.dispatchEvent(new CustomEvent("recording-stop",{detail:{blob:i,filename:a}})),e({blob:i,filename:a})}},this.recorderNode.port.postMessage({type:"stop"})})}getTimeDomainData(e){var t;(t=this.analyser)==null||t.getByteTimeDomainData(e)}getFrequencyData(e){var t;(t=this.analyser)==null||t.getByteFrequencyData(e)}isPageVisible(){return ve()}}function $e(s){const e=new TextEncoder().encode(s);let t="";for(const i of e)t+=String.fromCharCode(i);return btoa(t).replace(/\+/g,"-").replace(/\//g,"_").replace(/=+$/,"")}function ze(s){const e=s.replace(/-/g,"+").replace(/_/g,"/"),t=e.length%4?"=".repeat(4-e.length%4):"",i=atob(e+t),a=new Uint8Array(i.length);for(let r=0;r<i.length;r++)a[r]=i.charCodeAt(r);return new TextDecoder().decode(a)}function He(){const s=location.hash.match(/#s=([A-Za-z0-9\-_]+)/);if(!s)return null;try{const e=ze(s[1]);return JSON.parse(e)}catch{return null}}function Ie(s){const e=JSON.stringify(s),i=`#s=${$e(e)}`;return history.replaceState(null,"",i),location.href}const U={PRESET:"formula_audio_lab_preset_v2",HELP_SHOWN:"formula_audio_lab_help_shown"};function Ve(s){localStorage.setItem(U.PRESET,JSON.stringify(s))}function Ue(){const s=localStorage.getItem(U.PRESET);if(!s)return null;try{return JSON.parse(s)}catch{return null}}function We(){return localStorage.getItem(U.HELP_SHOWN)==="true"}function Ke(){localStorage.setItem(U.HELP_SHOWN,"true")}const Qe=.25,se={filterOn:!1,filterType:"lowpass",filterFreq:1e3,filterQ:.7,chorusOn:!1,chorusMode:"chorus",chorusRate:.35,chorusDepth:6,chorusMix:.35,chorusFb:.15,reverbOn:!1,reverbDecay:2.8,reverbMix:.25,limiterOn:!1,limiterThr:-12,limiterRel:.15,delayOn:!1,delayTime:.35,delayFb:.4,delayMix:.3,phaserOn:!1,phaserRate:.5,phaserDepth:.7,phaserStages:4,phaserFb:.3,phaserMix:.5},Ye=2,X=[{name:"Stillness meditation",state:{v:2,masterGain:.514,fx:{filterOn:!0,filterType:"lowpass",filterFreq:3400,filterQ:6.3,chorusOn:!0,chorusMode:"chorus",chorusRate:.01,chorusDepth:8.4,chorusMix:.35,chorusFb:.95,reverbOn:!0,reverbDecay:3.2,reverbMix:.5,limiterOn:!0,limiterThr:-12,limiterRel:.15,delayOn:!0,delayTime:.63,delayFb:.62,delayMix:.3,phaserOn:!0,phaserRate:.47,phaserDepth:.59,phaserStages:4,phaserFb:.62,phaserMix:.22},formulas:{additive:{enabled:!0,params:{gain:.474,fund:57,N:12,move:.35}},rossler:{enabled:!0,params:{gain:.169,rossA:.181,rossB:.238,rossC:6.42,rossBase:345,rossFreqScale:38.4,rossAmp:.25}}}}},{name:"Waiting for the subway",state:{v:2,masterGain:.514,fx:{filterOn:!0,filterType:"lowpass",filterFreq:2e3,filterQ:6.3,chorusOn:!0,chorusMode:"flanger",chorusRate:.98,chorusDepth:5.7,chorusMix:.68,chorusFb:.45,reverbOn:!0,reverbDecay:3.2,reverbMix:1,limiterOn:!0,limiterThr:-12,limiterRel:.15,delayOn:!1,delayTime:1.77,delayFb:.62,delayMix:1,phaserOn:!1,phaserRate:5.25,phaserDepth:.38,phaserStages:4,phaserFb:.62,phaserMix:.22},formulas:{additive:{enabled:!0,params:{gain:.255,fund:200,N:5,move:3.94}},lorenz:{enabled:!0,params:{gain:.498,sigma:10,rho:24.51,beta:2.6667,lBase:192,lFreqScale:40,lAmp:.25}},noiselp:{enabled:!0,params:{gain:.081,nCut:2085}}}}},{name:"Inside the nuclear power plant",state:{v:2,masterGain:.536,fx:{filterOn:!0,filterType:"lowpass",filterFreq:2e3,filterQ:10.3,chorusOn:!0,chorusMode:"flanger",chorusRate:.15,chorusDepth:.6,chorusMix:.28,chorusFb:.88,reverbOn:!0,reverbDecay:8,reverbMix:.36,limiterOn:!0,limiterThr:-12,limiterRel:.15,delayOn:!1,delayTime:1.77,delayFb:.62,delayMix:1,phaserOn:!1,phaserRate:5.25,phaserDepth:.38,phaserStages:8,phaserFb:.62,phaserMix:.22},formulas:{additive:{enabled:!0,params:{gain:.529,fund:110,N:19,move:2.5}}}}},{name:"Long journey on the helicopter",state:{v:2,masterGain:.585,fx:{filterOn:!0,filterType:"lowpass",filterFreq:285,filterQ:13.3,chorusOn:!0,chorusMode:"flanger",chorusRate:.13,chorusDepth:1.2,chorusMix:.65,chorusFb:.8,reverbOn:!1,reverbDecay:5.5,reverbMix:.36,limiterOn:!0,limiterThr:-12,limiterRel:.15,delayOn:!1,delayTime:1.77,delayFb:.62,delayMix:1,phaserOn:!1,phaserRate:4.19,phaserDepth:.59,phaserStages:4,phaserFb:.62,phaserMix:.22},formulas:{additive:{enabled:!0,params:{gain:.733,fund:56,N:23,move:2.5}},rossler:{enabled:!0,params:{gain:.458,rossA:.085,rossB:.472,rossC:7.06,rossBase:51,rossFreqScale:100,rossAmp:.605}},velvetnoise:{enabled:!0,params:{gain:.883,velvetDensity:2e3}}}}},{name:"Abandoned shrine",state:{v:2,masterGain:.25,fx:{filterOn:!0,filterType:"lowpass",filterFreq:2e3,filterQ:.7,chorusOn:!0,chorusMode:"chorus",chorusRate:.01,chorusDepth:6.6,chorusMix:.35,chorusFb:.95,reverbOn:!0,reverbDecay:2.8,reverbMix:.25,limiterOn:!0,limiterThr:-12,limiterRel:.15,delayOn:!1,delayTime:.35,delayFb:.4,delayMix:.3,phaserOn:!1,phaserRate:.5,phaserDepth:.7,phaserStages:4,phaserFb:.3,phaserMix:.5},formulas:{additive:{enabled:!0,params:{gain:.526,fund:57,N:12,move:.35}},lorenz:{enabled:!0,params:{gain:.293,sigma:10,rho:28,beta:2.6667,lBase:120,lFreqScale:40,lAmp:.25}},noiselp:{enabled:!0,params:{gain:.1,nCut:800}}}}}];class je{getDefaultState(){const e={};for(const t of O){const i={};for(const a of t.sliders)i[a.k]=a.value;e[t.id]={enabled:!1,params:i}}return{v:Ye,masterGain:Qe,fx:{...se},formulas:e}}getDefaultFX(){return{...se}}loadFromURL(){return He()}saveToURL(e){return Ie(e)}saveToStorage(e){Ve(e)}loadFromStorage(){return Ue()}hasSeenHelp(){return We()}markHelpShown(){Ke()}mergeWithDefaults(e){const t=this.getDefaultState();return{v:e.v??t.v,masterGain:e.masterGain??t.masterGain,fx:{...t.fx,...e.fx},formulas:{...t.formulas,...e.formulas}}}}function k(s){return document.querySelector(s)}function v(s){const e=document.querySelector(s);if(!e)throw new Error(`Element not found: ${s}`);return e}class Xe{constructor(e,t){this.audio=t,this.scopeMode="spectrum",this.scopeAutoGain=1,this.spectroCanvas=null,this.spectroCtx=null,this.lastCanvasWidth=0,this.lastCanvasHeight=0,this.lastSpectroTime=0,this.SPECTRO_INTERVAL=33,this.timeBuf=null,this.freqBuf=null,this.rafId=null,this.draw=()=>{if(this.rafId=requestAnimationFrame(this.draw),!this.audio.analyserNode||!this.timeBuf||!this.freqBuf||!this.audio.isPageVisible())return;this.audio.getTimeDomainData(this.timeBuf),this.audio.getFrequencyData(this.freqBuf);let i=1e-4;for(let u=0;u<this.timeBuf.length;u++){const m=(this.timeBuf[u]-128)/128,l=Math.abs(m);l>i&&(i=l)}let a=.85/i;a=Math.max(.25,Math.min(12,a)),this.scopeAutoGain+=(a-this.scopeAutoGain)*.08;const r=this.canvas.width,c=this.canvas.height;(r!==this.lastCanvasWidth||c!==this.lastCanvasHeight)&&this.initSpectro(r,c,this.freqBuf.length),this.scopeMode==="spectrum"?this.drawSpectrum(r,c):this.drawWave(r,c)},this.canvas=e,this.ctx=e.getContext("2d"),window.addEventListener("resize",()=>this.resize()),this.resize()}get mode(){return this.scopeMode}setMode(e){this.scopeMode=e}toggleMode(){return this.scopeMode=this.scopeMode==="wave"?"spectrum":"wave",this.scopeMode}resize(){const e=window.devicePixelRatio||1,t=this.canvas.getBoundingClientRect();this.canvas.width=Math.max(1,Math.floor(t.width*e)),this.canvas.height=Math.max(1,Math.floor(t.height*e)),this.audio.analyserNode&&this.initSpectro(this.canvas.width,this.canvas.height,this.audio.analyserNode.frequencyBinCount)}start(){if(this.rafId!==null)return;const e=this.audio.analyserNode;e&&(this.timeBuf=new Uint8Array(e.fftSize),this.freqBuf=new Uint8Array(e.frequencyBinCount),this.initSpectro(this.canvas.width,this.canvas.height,e.frequencyBinCount),this.draw())}stop(){this.rafId!==null&&(cancelAnimationFrame(this.rafId),this.rafId=null)}initSpectro(e,t,i){if(this.spectroCanvas&&this.lastCanvasWidth===e&&this.lastCanvasHeight===t)return;const a=document.createElement("canvas");a.width=e,a.height=t;const r=a.getContext("2d");r.fillStyle="#060a0f",r.fillRect(0,0,e,t),this.spectroCanvas&&this.spectroCtx&&r.drawImage(this.spectroCanvas,0,0,e,t),this.spectroCanvas=a,this.spectroCtx=r,this.lastCanvasWidth=e,this.lastCanvasHeight=t}getSpectroColor(e){const t=Math.min(255,Math.max(0,e)),i=240-t/255*240,a=20+t/255*40;return`hsl(${i}, 100%, ${a}%)`}drawSpectrum(e,t){const i=performance.now();if(i-this.lastSpectroTime>=this.SPECTRO_INTERVAL&&(this.lastSpectroTime=i,this.spectroCtx&&this.freqBuf)){this.spectroCtx.drawImage(this.spectroCanvas,-2,0);const r=this.freqBuf.length,c=20,u=1e4,m=this.audio.sampleRate/2;for(let l=0;l<t;l++){const g=l/t,f=u*Math.pow(c/u,g),y=Math.floor(f/m*r),S=this.freqBuf[Math.min(y,r-1)];this.spectroCtx.fillStyle=this.getSpectroColor(S),this.spectroCtx.fillRect(e-2,l,2,1)}}this.spectroCtx?this.ctx.drawImage(this.spectroCanvas,0,0):(this.ctx.fillStyle="#060a0f",this.ctx.fillRect(0,0,e,t))}drawWave(e,t){this.ctx.fillStyle="#060a0f",this.ctx.fillRect(0,0,e,t),this.ctx.strokeStyle="rgba(18, 32, 51, 0.7)",this.ctx.lineWidth=1,this.ctx.beginPath();for(let r=1;r<10;r++){const c=e*r/10;this.ctx.moveTo(c,0),this.ctx.lineTo(c,t)}for(let r=1;r<5;r++){const c=t*r/5;this.ctx.moveTo(0,c),this.ctx.lineTo(e,c)}if(this.ctx.stroke(),!this.timeBuf)return;const i=t/2;this.ctx.strokeStyle="#8ab4ff",this.ctx.lineWidth=2,this.ctx.beginPath();const a=this.scopeAutoGain;for(let r=0;r<this.timeBuf.length;r++){const c=(this.timeBuf[r]-128)/128,u=i-c*(i*.9)*a,m=e*r/(this.timeBuf.length-1);r===0?this.ctx.moveTo(m,u):this.ctx.lineTo(m,u)}this.ctx.stroke()}}const be=-135,Je=135,ye=Je-be,pe={normal:1.5,fine:.15};function ge(s){return be+s*ye}function xe(s){return Number.isInteger(s)?String(s):Math.abs(s)>=100?String(Math.round(s)):Math.abs(s)>=10?s.toFixed(1):s.toFixed(2)}function J(s){return Number.isInteger(s)?String(s):Math.abs(s)>=100?String(Math.round(s)):Math.abs(s)>=10||Math.abs(s)>=1?s.toFixed(1):s.toFixed(2)}function ie(s){const{id:e,min:t,max:i,step:a,value:r,size:c="md",label:u,showTicks:m=!0,onChange:l}=s,g=(t+i)/2,f=document.createElement("div");f.className=`knob-wrap knob-${c}`,f.dataset.knobId=e;const y=u?`<div class="knob-label">${u}</div>`:"",S=(r-t)/(i-t),B=ge(S),q=Ze(B,t,g,i,m);f.innerHTML=`
    ${y}
    <div class="knob-value" id="${e}_display">${xe(r)}</div>
    <div class="knob-container">
      ${q}
      ${m?`
        <span class="knob-tick-label knob-tick-min">${J(t)}</span>
        <span class="knob-tick-label knob-tick-mid">${J(g)}</span>
        <span class="knob-tick-label knob-tick-max">${J(i)}</span>
      `:""}
    </div>
  `;const T={value:r,min:t,max:i,step:a,defaultValue:r,isDragging:!1,startY:0,startValue:0},G=f.querySelector("svg"),W=G.querySelector(".knob-indicator"),N=f.querySelector(".knob-value"),F=(p,R=!0)=>{if(p=Math.max(t,Math.min(i,p)),p=Math.round(p/a)*a,p=Number(p.toFixed(10)),p===T.value)return;T.value=p;const C=(p-t)/(i-t),A=ge(C);W.setAttribute("transform",`rotate(${A}, 50, 50)`),N.textContent=xe(p),R&&l&&l(p)},P=p=>{p.preventDefault(),T.isDragging=!0,T.startY="touches"in p?p.touches[0].clientY:p.clientY,T.startValue=T.value,f.classList.add("dragging"),document.body.style.cursor="ns-resize"},_=p=>{if(!T.isDragging)return;const R="touches"in p?p.touches[0].clientY:p.clientY,C=T.startY-R,A=p.shiftKey?pe.fine:pe.normal,Q=C*A/ye*(i-t);F(T.startValue+Q)},$=()=>{T.isDragging&&(T.isDragging=!1,f.classList.remove("dragging"),document.body.style.cursor="")},M=()=>{F(T.defaultValue)},L=p=>{p.preventDefault();const R=p.shiftKey?.1:1,C=-Math.sign(p.deltaY)*a*R*5;F(T.value+C)};return G.addEventListener("mousedown",P),G.addEventListener("touchstart",P,{passive:!1}),G.addEventListener("dblclick",M),G.addEventListener("wheel",L,{passive:!1}),document.addEventListener("mousemove",_),document.addEventListener("touchmove",_,{passive:!1}),document.addEventListener("mouseup",$),document.addEventListener("touchend",$),f._knobState=T,f._updateValue=F,f}function Ze(s,e,t,i,a){return`
    <svg class="knob-svg" viewBox="0 0 100 100">
      <!-- Outer ring / track -->
      <circle class="knob-track" cx="50" cy="50" r="42" />

      <!-- Main knob body -->
      <circle class="knob-body" cx="50" cy="50" r="36" />

      <!-- Inner shadow/highlight -->
      <circle class="knob-inner" cx="50" cy="50" r="28" />

      ${a?`
      <!-- Tick marks -->
      <line class="knob-tick" x1="18" y1="82" x2="24" y2="76" />
      <line class="knob-tick" x1="50" y1="8" x2="50" y2="16" />
      <line class="knob-tick" x1="82" y1="82" x2="76" y2="76" />
    `:""}

      <!-- Indicator line -->
      <line
        class="knob-indicator"
        x1="50" y1="50"
        x2="50" y2="20"
        transform="rotate(${s}, 50, 50)"
      />

      <!-- Center dot -->
      <circle class="knob-center" cx="50" cy="50" r="4" />
    </svg>
  `}function I(s,e){const t=s._updateValue;t&&t(e,!1)}function Z(s){const e=s._knobState;return e?e.value:0}function et(s){return s==="gain"?"lg":s.includes("freq")||s.includes("Freq")||s==="f"||s==="fc"||s==="fm"||s==="f0"||s==="fbeat"||s==="fd"||s==="fq"?"md":"sm"}function tt(s,e){const t=document.createElement("div");t.className="formula",t.dataset.formulaId=s.id;const i=s.hasReset?`
      <div class="sep"></div>
      <div class="row">
        <button id="reset_${s.id}" disabled>Reset state</button>
      </div>`:"";t.innerHTML=`
    <div class="fhead">
      <div>
        <h3>
          <input type="checkbox" id="en_${s.id}">
          ${s.title}
        </h3>
        <div class="small">${s.desc}</div>
      </div>
      <div class="factions">
        <button class="collapseBtn" id="col_${s.id}" type="button">▼</button>
      </div>
    </div>

    <div class="fbody" id="body_${s.id}">
      <div class="knobs-grid" id="knobs_${s.id}"></div>${i}
    </div>
  `;const a=t.querySelector(`#knobs_${s.id}`);for(const l of s.sliders){const g=`${s.id}_${l.k}`,f=et(l.k),y=ie({id:g,min:l.min,max:l.max,step:l.step,value:l.value,size:f,label:l.name,showTicks:f!=="sm",onChange:S=>{e.onParamChange(s.id,l.k,S)}});a.appendChild(y)}const r=t.querySelector(`#en_${s.id}`),c=t.querySelector(`#col_${s.id}`),u=t.querySelector(`#body_${s.id}`),m=t.querySelector(`#reset_${s.id}`);return r.addEventListener("change",()=>{e.onEnable(s.id,r.checked)}),c.addEventListener("click",()=>{const l=!u.classList.contains("collapsed");u.classList.toggle("collapsed",l),c.textContent=l?"▶":"▼"}),m&&m.addEventListener("click",()=>{e.onReset(s.id)}),t}function H(s,e,t,i){const a=s.querySelector(`[data-formula-id="${e}"]`);if(!a)return;const r=a.querySelector(`#en_${e}`);r&&(r.checked=t),a.classList.toggle("active",t);for(const[l,g]of Object.entries(i)){const f=a.querySelector(`[data-knob-id="${e}_${l}"]`);f&&I(f,g)}const c=a.querySelector(`#reset_${e}`);c&&(c.disabled=!t);const u=a.querySelector(`#body_${e}`),m=a.querySelector(`#col_${e}`);u&&m&&(t&&u.classList.contains("collapsed")?(u.classList.remove("collapsed"),m.textContent="▼"):!t&&!u.classList.contains("collapsed")&&(u.classList.add("collapsed"),m.textContent="▶"))}const st={filter:[{id:"fxFilterFreq",label:"Cutoff",min:20,max:2e3,step:1,value:1e3,stateKey:"filterFreq"},{id:"fxFilterQ",label:"Q",min:.1,max:30,step:.1,value:.7,stateKey:"filterQ"}],chorus:[{id:"fxChorusRate",label:"Rate",min:.01,max:8,step:.01,value:.35,stateKey:"chorusRate"},{id:"fxChorusDepth",label:"Depth",min:0,max:20,step:.1,value:6,stateKey:"chorusDepth"},{id:"fxChorusMix",label:"Mix",min:0,max:1,step:.01,value:.35,stateKey:"chorusMix"},{id:"fxChorusFb",label:"Feedback",min:0,max:.95,step:.01,value:.15,stateKey:"chorusFb"}],reverb:[{id:"fxReverbDecay",label:"Decay",min:.1,max:8,step:.1,value:2.8,stateKey:"reverbDecay"},{id:"fxReverbMix",label:"Mix",min:0,max:1,step:.01,value:.25,stateKey:"reverbMix"}],limiter:[{id:"fxLimiterThr",label:"Threshold",min:-40,max:0,step:.5,value:-12,stateKey:"limiterThr"},{id:"fxLimiterRel",label:"Release",min:.02,max:1,step:.01,value:.15,stateKey:"limiterRel"}],delay:[{id:"fxDelayTime",label:"Time",min:.05,max:2,step:.01,value:.35,stateKey:"delayTime"},{id:"fxDelayFb",label:"Feedback",min:0,max:.9,step:.01,value:.4,stateKey:"delayFb"},{id:"fxDelayMix",label:"Mix",min:0,max:1,step:.01,value:.3,stateKey:"delayMix"}],phaser:[{id:"fxPhaserRate",label:"Rate",min:.1,max:10,step:.01,value:.5,stateKey:"phaserRate"},{id:"fxPhaserDepth",label:"Depth",min:0,max:1,step:.01,value:.7,stateKey:"phaserDepth"},{id:"fxPhaserFb",label:"Feedback",min:0,max:.9,step:.01,value:.3,stateKey:"phaserFb"},{id:"fxPhaserMix",label:"Mix",min:0,max:1,step:.01,value:.5,stateKey:"phaserMix"}]};async function it(){var ce,le,he;const s=new _e,e=new je,t=new Map;let i=null;const a=v("#status"),r=v("#playStopBtn"),c=v("#recBtn"),u=v("#savePresetBtn"),m=v("#loadPresetBtn"),l=v("#shareBtn"),g=v("#presetSelect"),f=v("#scopeToggleBtn"),y=v("#scopeModeBtn"),S=v("#effectsBtn"),B=v("#scopeWrap"),q=v("#effectsPanel"),T=v("#masterGainWrap"),G=v("#formulas"),W=v("#disableAllBtn"),N=v("#collapseAllBtn"),F=v("#helpOverlay"),P=v("#helpBtn"),_=v("#helpCloseBtn"),$=v("#scope");let M=null,L=!1;i=ie({id:"masterGain",min:0,max:1,step:.001,value:.25,size:"lg",label:"Master Volume",showTicks:!0,onChange:n=>{s.setMasterGain(n)}}),T.appendChild(i);function p(){for(const[n,d]of Object.entries(st)){const h=k(`#${n}Knobs`);if(h)for(const o of d){const x=ie({id:o.id,min:o.min,max:o.max,step:o.step,value:o.value,size:"sm",label:o.label,showTicks:!1,onChange:()=>{s.isRunning&&s.updateEffectParams(C())}});h.appendChild(x),t.set(o.id,x)}}}p();function R(){const n={};for(const h of O){const o=k(`#en_${h.id}`),x=(o==null?void 0:o.checked)??!1,b={};for(const w of h.sliders){const E=document.querySelector(`[data-knob-id="${h.id}_${w.k}"]`);b[w.k]=E?Z(E):w.value}n[h.id]={enabled:x,params:b}}return{v:2,masterGain:i?Z(i):.25,fx:C(),formulas:n}}function C(){var d,h,o,x,b,w,E,ue,de;const n=(Re,Fe)=>{const me=t.get(Re);return me?Z(me):Fe};return{filterOn:((d=k("#fxFilterOn"))==null?void 0:d.checked)??!1,filterType:((h=k("#fxFilterType"))==null?void 0:h.value)??"lowpass",filterFreq:n("fxFilterFreq",1e3),filterQ:n("fxFilterQ",.7),chorusOn:((o=k("#fxChorusOn"))==null?void 0:o.checked)??!1,chorusMode:((x=k("#fxChorusMode"))==null?void 0:x.value)??"chorus",chorusRate:n("fxChorusRate",.35),chorusDepth:n("fxChorusDepth",6),chorusMix:n("fxChorusMix",.35),chorusFb:n("fxChorusFb",.15),reverbOn:((b=k("#fxReverbOn"))==null?void 0:b.checked)??!1,reverbDecay:n("fxReverbDecay",2.8),reverbMix:n("fxReverbMix",.25),limiterOn:((w=k("#fxLimiterOn"))==null?void 0:w.checked)??!1,limiterThr:n("fxLimiterThr",-12),limiterRel:n("fxLimiterRel",.15),delayOn:((E=k("#fxDelayOn"))==null?void 0:E.checked)??!1,delayTime:n("fxDelayTime",.35),delayFb:n("fxDelayFb",.4),delayMix:n("fxDelayMix",.3),phaserOn:((ue=k("#fxPhaserOn"))==null?void 0:ue.checked)??!1,phaserRate:n("fxPhaserRate",.5),phaserDepth:n("fxPhaserDepth",.7),phaserStages:Number(((de=k("#fxPhaserStages"))==null?void 0:de.value)??4),phaserFb:n("fxPhaserFb",.3),phaserMix:n("fxPhaserMix",.5)}}function A(n,d=!1){var h;d&&Q(),i&&I(i,n.masterGain),K(n.fx);for(const o of O){const x=(h=n.formulas)==null?void 0:h[o.id];x&&H(G,o.id,x.enabled,x.params)}}function K(n){const d=(x,b)=>{const w=k(x);w&&b!==void 0&&(w.value=String(b))},h=(x,b)=>{const w=k(x);w&&b!==void 0&&(w.checked=!!b)},o=(x,b)=>{const w=t.get(x);w&&b!==void 0&&I(w,Number(b))};h("#fxFilterOn",n.filterOn),h("#fxChorusOn",n.chorusOn),h("#fxReverbOn",n.reverbOn),h("#fxLimiterOn",n.limiterOn),h("#fxDelayOn",n.delayOn),h("#fxPhaserOn",n.phaserOn),d("#fxFilterType",n.filterType),d("#fxChorusMode",n.chorusMode),d("#fxPhaserStages",n.phaserStages),o("fxFilterFreq",n.filterFreq),o("fxFilterQ",n.filterQ),o("fxChorusRate",n.chorusRate),o("fxChorusDepth",n.chorusDepth),o("fxChorusMix",n.chorusMix),o("fxChorusFb",n.chorusFb),o("fxReverbDecay",n.reverbDecay),o("fxReverbMix",n.reverbMix),o("fxLimiterThr",n.limiterThr),o("fxLimiterRel",n.limiterRel),o("fxDelayTime",n.delayTime),o("fxDelayFb",n.delayFb),o("fxDelayMix",n.delayMix),o("fxPhaserRate",n.phaserRate),o("fxPhaserDepth",n.phaserDepth),o("fxPhaserFb",n.phaserFb),o("fxPhaserMix",n.phaserMix)}function Q(){i&&I(i,.25),K(se);for(const n of O){const d={};for(const h of n.sliders)d[h.k]=h.value;H(G,n.id,!1,d)}}async function ne(){const n=R();await s.start(n),a.textContent="running",r.textContent="⏹ Stop",r.classList.add("playing"),c.disabled=!1,M=new Xe($,s),M.start()}async function ke(){M==null||M.stop(),M=null,await s.stop(),a.textContent="stopped",r.textContent="▶ Play",r.classList.remove("playing"),c.disabled=!0,c.textContent="Record",c.classList.remove("recording")}async function we(){s.isRunning?await ke():await ne()}async function Te(){var n;if(!s.isRunning){a.textContent="start audio first";return}if(!s.isRecording)s.startRecording(),c.textContent="● REC",c.classList.add("recording"),a.textContent="recording…";else{c.disabled=!0,c.classList.remove("recording"),a.textContent="finalizing…";const d=await s.stopRecording();if(d){const{blob:h,filename:o}=d,x=new File([h],o,{type:"audio/wav"});if("share"in navigator&&((n=navigator.canShare)==null?void 0:n.call(navigator,{files:[x]})))try{await navigator.share({files:[x],title:"Formula Audio Recording"}),a.textContent="shared"}catch(w){w.name!=="AbortError"&&ae(h,o)}else ae(h,o)}c.disabled=!1,c.textContent="Record"}}function ae(n,d){const h=URL.createObjectURL(n),o=document.createElement("a");o.href=h,o.download=d,o.click(),a.innerHTML=`ready — <a href="${h}" download="${d}" style="color:#8ab4ff;">download</a>`}function Y(n){B.classList.toggle("scopeCollapsed",n),f.classList.toggle("active",!n),n||setTimeout(()=>M==null?void 0:M.resize(),0)}function re(){F.classList.add("open")}function j(){F.classList.remove("open"),e.markHelpShown()}for(const n of O){const d=tt(n,{onEnable:async(h,o)=>{o&&!s.isRunning&&await ne(),s.isRunning&&(s.enableFormula(h,o),H(G,h,o,R().formulas[h].params))},onParamChange:(h,o,x)=>{if(s.isRunning&&(s.updateFormulaParam(h,o,x),o==="gain")){const b=k(`#en_${h}`);b!=null&&b.checked&&s.enableFormula(h,!0)}},onReset:h=>{s.isRunning&&s.resetFormula(h)}});G.appendChild(d)}for(let n=0;n<X.length;n++){const d=document.createElement("option");d.value=String(n),d.textContent=X[n].name,g.appendChild(d)}r.addEventListener("click",we),c.addEventListener("click",Te),W.addEventListener("click",()=>{for(const n of O)s.enableFormula(n.id,!1),H(G,n.id,!1,R().formulas[n.id].params)}),N.addEventListener("click",()=>{L=!L;for(const n of O){const d=k(`#body_${n.id}`),h=k(`#col_${n.id}`);d==null||d.classList.toggle("collapsed",L),h&&(h.textContent=L?"▶":"▼")}N.textContent=L?"▶ Expand all":"▼ Collapse all"}),f.addEventListener("click",()=>{Y(!B.classList.contains("scopeCollapsed"))}),y.addEventListener("click",()=>{if(M){const n=M.toggleMode();y.textContent=n==="wave"?"Wave":"Spectrum"}}),S.addEventListener("click",()=>{const n=!q.classList.contains("open");q.classList.toggle("open",n),S.classList.toggle("active",n),Y(n)});const Me=["fxFilterOn","fxChorusOn","fxReverbOn","fxLimiterOn","fxDelayOn","fxPhaserOn"];for(const n of Me)(ce=k(`#${n}`))==null||ce.addEventListener("change",()=>{s.isRunning&&s.updateEffects(C())});const Ce=["fxFilterType","fxChorusMode","fxPhaserStages"];for(const n of Ce)(le=k(`#${n}`))==null||le.addEventListener("change",()=>{s.isRunning&&s.updateEffectParams(C())});u.addEventListener("click",()=>{e.saveToStorage(R()),a.textContent="preset saved"}),m.addEventListener("click",()=>{const n=e.loadFromStorage();if(!n){a.textContent="no preset";return}A(n),s.isRunning&&s.updateEffects(C()),a.textContent="preset loaded"}),l.addEventListener("click",async()=>{const n=e.saveToURL(R());try{await navigator.clipboard.writeText(n),a.textContent="link copied"}catch{a.textContent="link in URL"}}),g.addEventListener("change",()=>{const n=g.value;if(n==="")return;const d=X[Number(n)];d!=null&&d.state&&(A(d.state,!0),s.isRunning&&s.updateEffects(C()),a.textContent=`loaded: ${d.name}`)}),P.addEventListener("click",re),_.addEventListener("click",j),F.addEventListener("click",n=>{n.target===F&&j()}),document.addEventListener("keydown",n=>{n.key==="Escape"&&F.classList.contains("open")&&j()});const Ge=((he=window.matchMedia)==null?void 0:he.call(window,"(max-width: 600px)").matches)??!1;Y(Ge);const oe=e.loadFromURL();oe&&A(oe),e.hasSeenHelp()||re()}it().catch(console.error);
//# sourceMappingURL=index-Bfz9pXEE.js.map
